---
import "../styles/global.css";
---

<html lang="sk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ratrak.sk</title>
  </head>

  <body>
    <main class="container">
      <h1>
        I build software.<br />
        I teach kids to build things too.
      </h1>

      <p>Backend-first brain. Minimal UI. Pixel ratrak companion.</p>

      <div class="card" style="margin-top: 24px;">
        <strong style="color: var(--text);">Next:</strong>
        <span style="color: var(--muted);"> Ratrak sprite + sidebar menu</span>
      </div>

	  <section id="about" style="margin-top: 56px;">
  <h2 style="margin: 0 0 10px 0;">About</h2>
  <p>Backend developer. Minimal UI enjoyer. Ratrak is my pixel companion.</p>
</section>

<section id="projects" style="margin-top: 40px;">
  <h2 style="margin: 0 0 10px 0;">Projects</h2>
  <p>Coming soon: a few things I built and what I learned.</p>
</section>

<section id="teaching" style="margin-top: 40px;">
  <h2 style="margin: 0 0 10px 0;">Teaching</h2>
  <p>I run programming courses for kids — curious minds, playful learning.</p>
</section>

<section id="logbook" style="margin-top: 40px;">
  <h2 style="margin: 0 0 10px 0;">Logbook</h2>
  <p>Short notes instead of a blog. No pressure.</p>
</section>

    </main>

    <!-- RATRAK BUTTON -->
<button id="ratrakBtn" class="ratrak-btn" aria-label="Open Ratrak menu">
  <div class="ratrak-sprite">
	<img
	id="ratrakSprite"
	src="/ratrak/idle.png"
	width="48"
	height="48"
	alt=""
	/>
	</div>
</button>

<!-- BACKDROP -->
<div id="ratrakBackdrop" class="ratrak-backdrop" data-open="false" aria-hidden="true"></div>

<!-- DRAWER -->
<aside
  id="ratrakDrawer"
  class="ratrak-drawer"
  data-open="false"
  aria-hidden="true"
  aria-label="Ratrak menu"
>
  <div class="drawer-title">
    <div>
      <strong>ratrak</strong> <small>v0.1</small>
    </div>
    <span class="kbd-hint">Esc</span>
  </div>

  <p style="margin: 0 0 10px 0;">Quick shortcuts. Click outside to close.</p>

  <nav class="drawer-nav">
    <a class="drawer-link" href="#about"><span>about</span><span class="kbd-hint">A</span></a>
    <a class="drawer-link" href="#projects"><span>projects</span><span class="kbd-hint">P</span></a>
    <a class="drawer-link" href="#teaching"><span>teaching</span><span class="kbd-hint">T</span></a>
    <a class="drawer-link" href="#logbook"><span>logbook</span><span class="kbd-hint">L</span></a>
  </nav>
</aside>

<div id="ratrakBubble" class="ratrak-bubble" data-show="false" aria-hidden="true">
  <code id="ratrakBubbleText">&gt; terrain stable</code>
</div>


<script>
  // --- DOM ---
  const btn = document.getElementById("ratrakBtn");
  const drawer = document.getElementById("ratrakDrawer");
  const backdrop = document.getElementById("ratrakBackdrop");

  const bubble = document.getElementById("ratrakBubble");
  const bubbleText = document.getElementById("ratrakBubbleText");

  const spriteEl = document.getElementById("ratrakSprite");

  // --- Content ---
  const QUOTES = [
    "> terrain stable",
    "> grooming…",
    "> compiling snow",
    "> backend ready",
    "> tests passing",
    "> shipping…",
    "> still running",
    "> no bugs. just features.",
    "> warming up…",
    "> cache is warm",
    "> edge case detected",
    "> refactoring tracks",
    "> logging…",
    "> kids ask the best questions",
    "> beep boop",
  ];

  // --- Helpers ---
  const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
  const chance = (p) => Math.random() < p;
  const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

  // --- UI: Drawer ---
  function setDrawerOpen(open) {
    drawer.dataset.open = String(open);
    backdrop.dataset.open = String(open);
    drawer.setAttribute("aria-hidden", String(!open));
    backdrop.setAttribute("aria-hidden", String(!open));
    btn.setAttribute("aria-label", open ? "Close Ratrak menu" : "Open Ratrak menu");
  }

  function toggleDrawer() {
    const open = drawer.dataset.open === "true";
    setDrawerOpen(!open);
    // Visual feedback
    Ratrak.setState(!open ? "work" : "idle", { holdMs: 700 });
    // Optional: say something when opening
    if (!open) maybeSay("open");
  }

  // --- Controller: Ratrak ---
  const Ratrak = (() => {
    const SPRITES = {
      idle: "/ratrak/idle.png",
      blink: "/ratrak/blink.png",
      move: "/ratrak/move.png",
      work: "/ratrak/work.png",
    };

    let state = "idle";
    let holdTimer = null;

    // anti-spam for idle blinks
    let lastIdleBlinkAt = 0;
    let idleLoopTimer = null;

    function apply(stateName) {
      if (!spriteEl) return;
      const src = SPRITES[stateName];
      if (!src) return;
      state = stateName;
      spriteEl.src = src;
    }

    function setState(stateName, opts = {}) {
      const { holdMs = 0, revertTo = "idle" } = opts;
      apply(stateName);

      window.clearTimeout(holdTimer);
      if (holdMs > 0 && stateName !== revertTo) {
        holdTimer = window.setTimeout(() => apply(revertTo), holdMs);
      }
    }

    function pulse(stateName, ms = 450) {
      // short visual pulse then return to idle
      setState(stateName, { holdMs: ms, revertTo: "idle" });
    }

    function startIdleBlinkLoop() {
      if (idleLoopTimer) return;

      idleLoopTimer = window.setInterval(() => {
        // Only blink if we're idle and drawer is closed
        const drawerOpen = drawer?.dataset.open === "true";
        if (drawerOpen) return;
        if (state !== "idle") return;

        const now = Date.now();
        const cooldown = randInt(20_000, 60_000); // 20–60s
        if (now - lastIdleBlinkAt < cooldown) return;

        // probability gate (so it's not deterministic)
        if (!chance(0.45)) return;

        lastIdleBlinkAt = now;
        pulse("blink", randInt(300, 600));
      }, 3_500); // check every ~3.5s
    }

    function stopIdleBlinkLoop() {
      window.clearInterval(idleLoopTimer);
      idleLoopTimer = null;
    }

    return {
      setState,
      pulse,
      startIdleBlinkLoop,
      stopIdleBlinkLoop,
      getState: () => state,
    };
  })();

  // --- UI: Bubble ---
  let bubbleTimer = null;
  let lastShownAt = 0;

  function canShowBubble() {
    const now = Date.now();
    const cooldown = randInt(30_000, 90_000);
    return now - lastShownAt > cooldown;
  }

  function showBubble(text, ms = 2400) {
    if (!bubble || !bubbleText) return;

    lastShownAt = Date.now();
    bubbleText.textContent = text;

    // Visual feedback
    if (drawer?.dataset.open === "true") {
      // while open, keep it calmer
      Ratrak.pulse("blink", 300);
    } else {
      Ratrak.pulse("blink", 450);
    }

    bubble.dataset.show = "true";
    bubble.setAttribute("aria-hidden", "false");

    window.clearTimeout(bubbleTimer);
    bubbleTimer = window.setTimeout(() => {
      bubble.dataset.show = "false";
      bubble.setAttribute("aria-hidden", "true");
      bubbleTimer = null;
    }, ms);
  }

  function maybeSay(reason = "idle") {
    if (!canShowBubble()) return;

    // Probability gates depending on reason
    const roll = Math.random();
    if (reason === "idle" && roll > 0.22) return;   // 22%
    if (reason === "scroll" && roll > 0.10) return; // 10%
    if (reason === "click" && roll > 0.70) return;  // 70%
    if (reason === "open" && roll > 0.75) return;   // 75%

    showBubble(pick(QUOTES));
  }

  // --- Events ---
  btn?.addEventListener("click", () => {
    // quick "move/work" pulse before drawer toggle feels good
    Ratrak.pulse("work", 550);
    maybeSay("click");
    toggleDrawer();
  });

  backdrop?.addEventListener("click", () => {
    setDrawerOpen(false);
    Ratrak.setState("idle");
  });

  window.addEventListener("keydown", (e) => {
    const open = drawer?.dataset.open === "true";
    if (e.key === "Escape") {
      setDrawerOpen(false);
      Ratrak.setState("idle");
    }

    // Shortcuts only when open
    if (!open) return;
    if (e.key.toLowerCase() === "a") location.hash = "#about";
    if (e.key.toLowerCase() === "p") location.hash = "#projects";
    if (e.key.toLowerCase() === "t") location.hash = "#teaching";
    if (e.key.toLowerCase() === "l") location.hash = "#logbook";
  });

  // Scroll: brief "move" pulse + rare chatter
  let scrollLock = null;
  window.addEventListener("scroll", () => {
    if (scrollLock) return;
    scrollLock = window.setTimeout(() => (scrollLock = null), 650);

    // only show move if drawer closed
    if (drawer?.dataset.open !== "true") {
      Ratrak.pulse("move", 350);
    }
    maybeSay("scroll");
  });

  // Idle chatter loop (separate from idle blink loop)
  setInterval(() => maybeSay("idle"), 12_000);

  // --- Init ---
  setDrawerOpen(false);
  Ratrak.setState("idle");
  Ratrak.startIdleBlinkLoop();

  window.addEventListener("load", () => {
    if (chance(0.5)) showBubble("> terrain stable", 1800);
  });
</script>



  </body>
</html>
